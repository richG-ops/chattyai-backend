# ðŸš€ Production Deployment Guide for TheChattyAI

## Pre-Deployment Checklist

- [ ] All code committed to main branch
- [ ] GitHub repository is public or Render has access
- [ ] Render account created and verified
- [ ] Wix domain management access available
- [ ] All API keys and credentials ready

## Step 1: Render Setup

### 1.1 Create Render Account
1. Go to https://render.com
2. Sign up with GitHub for easy integration
3. Connect your GitHub repository

### 1.2 Deploy Services via Blueprint
```bash
# In your repository root, commit the render.yaml
git add render.yaml
git commit -m "Add production Render blueprint"
git push origin main
```

1. In Render Dashboard, click "New" â†’ "Blueprint"
2. Select your repository
3. Review services to be created:
   - thechattyai-api (Web Service)
   - thechattyai-frontend (Web Service)
   - thechattyai-db (PostgreSQL)
   - thechattyai-cache (Redis)
4. Click "Apply"

### 1.3 Get Service IDs
After deployment, note down:
- API Service ID: `srv-xxxxxxxxxxxx`
- Frontend Service ID: `srv-yyyyyyyyyyyy`

## Step 2: Environment Variables

### 2.1 API Service Variables
In Render Dashboard â†’ thechattyai-api â†’ Environment:

```bash
# Core
NODE_ENV=production
PORT=4000

# JWT (auto-generated by Render)
JWT_SECRET=<auto-generated>

# Google Calendar
GOOGLE_CLIENT_ID=<from Google Cloud Console>
GOOGLE_CLIENT_SECRET=<from Google Cloud Console>
GOOGLE_REDIRECT_URI=https://thechattyai-api.onrender.com/oauth/callback
GOOGLE_CREDENTIALS=<paste entire credentials.json content>
GOOGLE_TOKEN=<paste entire token.json content>

# Twilio
TWILIO_ACCOUNT_SID=AC4c64f25251c2355995cc858286faf2d0
TWILIO_AUTH_TOKEN=98af8c3747ff3dcb871928ad76466f7b
TWILIO_FROM_NUMBER=+18778396798

# Vapi
VAPI_API_KEY=<your vapi key>

# Monitoring
SENTRY_DSN=<optional - from sentry.io>
```

### 2.2 Frontend Service Variables
In Render Dashboard â†’ thechattyai-frontend â†’ Environment:

```bash
NODE_ENV=production
NEXT_PUBLIC_API_URL=https://thechattyai-api.onrender.com
NEXTAUTH_SECRET=<auto-generated>
NEXTAUTH_URL=https://app.thechattyai.com
```

## Step 3: DNS Configuration

### 3.1 Get Render URLs
1. API URL: `https://thechattyai-api.onrender.com`
2. Frontend URL: Note the auto-generated URL (e.g., `https://thechattyai-frontend.onrender.com`)

### 3.2 Configure Custom Domain in Render
1. Go to thechattyai-frontend â†’ Settings â†’ Custom Domains
2. Add domain: `app.thechattyai.com`
3. Render will provide a CNAME target

### 3.3 Add DNS Records in Wix

In Wix Dashboard â†’ Domains â†’ Manage DNS Records:

```
Type: CNAME
Host: app
Value: thechattyai-frontend.onrender.com
TTL: 3600
```

**Important**: It may take 10-30 minutes for DNS propagation.

## Step 4: GitHub Secrets Setup

In your GitHub repository â†’ Settings â†’ Secrets â†’ Actions:

```bash
RENDER_API_KEY=<from Render account settings>
RENDER_API_SERVICE_ID=srv-xxxxxxxxxxxx
RENDER_FRONTEND_SERVICE_ID=srv-yyyyyyyyyyyy
SLACK_WEBHOOK=<optional - for notifications>
```

## Step 5: Deploy

```bash
# Trigger deployment
git add .
git commit -m "Production deployment configuration"
git push origin main
```

The GitHub Action will:
1. Run security scans
2. Execute tests
3. Build Docker images
4. Deploy to Render
5. Run health checks
6. Notify via Slack (if configured)

## Step 6: Verification

### 6.1 Health Checks

```bash
# Check API health
curl https://thechattyai-api.onrender.com/healthz

# Expected response:
{
  "status": "healthy",
  "service": "thechattyai-api",
  "timestamp": "2025-01-11T21:30:00.000Z",
  "uptime": 123.456
}

# Check Frontend health
curl https://app.thechattyai.com/api/health

# Expected response:
{
  "status": "healthy",
  "service": "thechattyai-frontend",
  "timestamp": "2025-01-11T21:30:00.000Z",
  "uptime": 123.456,
  "environment": "production"
}
```

### 6.2 Database Connectivity

```bash
# Check database migrations
curl https://thechattyai-api.onrender.com/api/health/db

# Test Redis cache
curl https://thechattyai-api.onrender.com/api/health/cache
```

### 6.3 End-to-End Test

1. Visit https://app.thechattyai.com
2. Sign up for a new account
3. Create an AI assistant
4. Make a test call
5. Book an appointment
6. Verify SMS notifications

## Step 7: Monitoring Setup

### 7.1 UptimeRobot
1. Create monitors for:
   - https://thechattyai-api.onrender.com/healthz
   - https://app.thechattyai.com/api/health
2. Set alert contacts (email, SMS, Slack)

### 7.2 Sentry (Optional)
1. Create project at sentry.io
2. Add SENTRY_DSN to environment variables
3. Errors will auto-report

### 7.3 Render Metrics
- View in Render Dashboard â†’ Service â†’ Metrics
- Monitor: CPU, Memory, Response Time, Error Rate

## Step 8: Wix Integration

### 8.1 Add Authentication Buttons
In Wix Editor, add buttons:
1. "Sign In" â†’ Link: https://app.thechattyai.com/login
2. "Try Demo" â†’ Link: https://app.thechattyai.com/demo
3. "Dashboard" â†’ Link: https://app.thechattyai.com/dashboard

### 8.2 Embed Demo (Optional)
```html
<iframe 
  src="https://app.thechattyai.com/demo" 
  width="100%" 
  height="600px"
  frameborder="0">
</iframe>
```

## Rollback Procedure

If deployment fails:

1. **Automatic Rollback**: Render auto-reverts on health check failure
2. **Manual Rollback**: 
   ```bash
   # In Render Dashboard
   Service â†’ Deploys â†’ Select previous deploy â†’ Rollback
   ```
3. **Emergency**: Update DNS to point to backup service

## Security Checklist

- [x] HTTPS enforced on all endpoints
- [x] Secrets in environment variables (never in code)
- [x] CORS configured for app.thechattyai.com only
- [x] Rate limiting enabled
- [x] SQL injection protection via parameterized queries
- [x] XSS protection headers set
- [x] CSRF protection in forms
- [x] Non-root Docker containers
- [x] Dependency scanning in CI/CD

## Cost Estimation

- Render Web Services (2x Standard): ~$14/month
- Render PostgreSQL (Standard): ~$20/month
- Render Redis (Starter): ~$10/month
- **Total**: ~$44/month

## Support

- Render Status: https://status.render.com
- Render Support: support@render.com
- GitHub Actions: Check .github/workflows/deploy.yml logs
- Application Logs: Render Dashboard â†’ Service â†’ Logs

---

ðŸŽ‰ **Congratulations!** Your production deployment is complete.
Monitor the services for the first 24 hours to ensure stability. 